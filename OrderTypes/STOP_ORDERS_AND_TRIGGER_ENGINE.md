# Stop Orders & Trigger Engine Architecture

> A comprehensive guide to stop order types and the trigger engine that powers them.

---

## Table of Contents

1. [Overview](#overview)
2. [Current Order Types vs Stop Order Types](#current-order-types-vs-stop-order-types)
3. [Stop Order Types Explained](#stop-order-types-explained)
4. [Why a Trigger Engine is Required](#why-a-trigger-engine-is-required)
5. [Architecture Diagram](#architecture-diagram)
6. [Detailed Behavior Comparison](#detailed-behavior-comparison)
7. [Implementation Considerations](#implementation-considerations)

---

## Overview

Stop orders are **conditional orders** that remain dormant until a specified trigger price is reached. Unlike regular limit and market orders that participate in matching immediately, stop orders wait for market conditions before becoming active.

### Key Concept

```
Regular Orders:  Submit â†’ Match Immediately â†’ Fill/Rest in Book
Stop Orders:     Submit â†’ Wait for Trigger â†’ Convert to Regular Order â†’ Match
```

---

## Current Order Types vs Stop Order Types

### Current Order Types (Active Orders)

These orders participate in matching **immediately** upon submission:

| Order Type | Price Required? | Execution Behavior | Rests in Book? |
|------------|-----------------|-------------------|----------------|
| **Limit** | âœ… Yes | Executes at specified price or better | âœ… Yes (if unfilled) |
| **Market** | âŒ No | Executes immediately at best available price | âŒ No |

### Stop Order Types (Conditional/Dormant Orders)

These orders remain **dormant** until a trigger condition is met:

| Stop Type | Trigger Price | Limit Price | When Triggered Becomes | Use Case |
|-----------|---------------|-------------|----------------------|----------|
| **StopMarket** | âœ… Required | âŒ None | Market Order | Quick exit on breakout/breakdown |
| **StopLimit** | âœ… Required | âœ… Required | Limit Order | Controlled exit with price protection |
| **TrailingStop** | ðŸ”„ Dynamic | âš™ï¸ Optional | Market or Limit | Lock in profits as price moves |

---

## Stop Order Types Explained

### 1. StopMarket

A StopMarket order becomes a **Market order** when the trigger price is reached.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      StopMarket Order                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Configuration:                                              â”‚
â”‚    â€¢ Side: Sell                                              â”‚
â”‚    â€¢ Trigger Price: $95                                      â”‚
â”‚    â€¢ Quantity: 100 shares                                    â”‚
â”‚                                                              â”‚
â”‚  Lifecycle:                                                  â”‚
â”‚                                                              â”‚
â”‚    [Submit]                                                  â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ DORMANT         â”‚  â† Waiting in Trigger Engine         â”‚
â”‚    â”‚ (Not in book)   â”‚    Market price: $100                â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚             â”‚                                                â”‚
â”‚             â”‚ Market trades at $95                           â”‚
â”‚             â–¼                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ TRIGGERED!      â”‚                                       â”‚
â”‚    â”‚ Convert to      â”‚                                       â”‚
â”‚    â”‚ Market Sell     â”‚                                       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚             â”‚                                                â”‚
â”‚             â–¼                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ EXECUTED        â”‚  â† Fills at best available bid       â”‚
â”‚    â”‚ @ $94.80        â”‚    (may slip from trigger price)     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                              â”‚
â”‚  âš ï¸  Risk: Execution price may differ from trigger price    â”‚
â”‚      (slippage) in fast-moving markets.                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use Cases:**
- Stop-loss orders for risk management
- Breakout trading (buy when price exceeds resistance)
- Breakdown trading (sell when price falls below support)

---

### 2. StopLimit

A StopLimit order becomes a **Limit order** when the trigger price is reached.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      StopLimit Order                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Configuration:                                              â”‚
â”‚    â€¢ Side: Sell                                              â”‚
â”‚    â€¢ Trigger Price: $95                                      â”‚
â”‚    â€¢ Limit Price: $94.50                                     â”‚
â”‚    â€¢ Quantity: 100 shares                                    â”‚
â”‚                                                              â”‚
â”‚  Lifecycle:                                                  â”‚
â”‚                                                              â”‚
â”‚    [Submit]                                                  â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ DORMANT         â”‚  â† Waiting in Trigger Engine         â”‚
â”‚    â”‚ (Not in book)   â”‚    Market price: $100                â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚             â”‚                                                â”‚
â”‚             â”‚ Market trades at $95                           â”‚
â”‚             â–¼                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ TRIGGERED!      â”‚                                       â”‚
â”‚    â”‚ Convert to      â”‚                                       â”‚
â”‚    â”‚ Limit Sell      â”‚                                       â”‚
â”‚    â”‚ @ $94.50        â”‚                                       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚             â”‚                                                â”‚
â”‚             â–¼                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ IN ORDER BOOK   â”‚  â† Now visible, waiting for match    â”‚
â”‚    â”‚ Resting @ $94.50â”‚    Will only fill at $94.50 or betterâ”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                              â”‚
â”‚  âš ï¸  Risk: If price gaps below $94.50, order may not fill   â”‚
â”‚      because limit price protection prevents execution.     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use Cases:**
- Stop-loss with price protection (avoid selling too low)
- Entry orders with price control
- Situations where you'd rather miss the trade than get a bad price

---

### 3. TrailingStop

A TrailingStop has a **dynamic trigger price** that follows favorable price movement.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TrailingStop Order                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Configuration:                                              â”‚
â”‚    â€¢ Side: Sell                                              â”‚
â”‚    â€¢ Trail Amount: $5 (or Trail Percent: 5%)                â”‚
â”‚    â€¢ Quantity: 100 shares                                    â”‚
â”‚                                                              â”‚
â”‚  Dynamic Trigger Behavior (Sell Side):                       â”‚
â”‚                                                              â”‚
â”‚  Price ($)                                                   â”‚
â”‚    115 â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â” Peak                            â”‚
â”‚        â”‚                   â”‚                                 â”‚
â”‚    110 â”€â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚â”€ â”€ â”€ Trigger follows ($5 below)â”‚
â”‚        â”‚                   â”‚     â”‚                           â”‚
â”‚    105 â”€â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚â”€ â”€ â”€â”‚â”€ â”€ â”€                      â”‚
â”‚        â”‚   Price rises     â”‚     â”‚                           â”‚
â”‚    100 â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚                           â”‚
â”‚        â”‚   â†‘ Trigger       â”‚     â”‚                           â”‚
â”‚     95 â”€â”‚â”€ â”€followsâ”€ â”€ â”€ â”€ â”€     â–¼                           â”‚
â”‚        â”‚                    â—â•â•â•â•â•â•â• TRIGGERED @ $110       â”‚
â”‚     90 â”€â”‚                                                    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Time      â”‚
â”‚                                                              â”‚
â”‚  Step-by-Step:                                               â”‚
â”‚    1. Start: Price $100, Trigger = $95 ($100 - $5)          â”‚
â”‚    2. Price rises to $110 â†’ Trigger updates to $105         â”‚
â”‚    3. Price rises to $115 â†’ Trigger updates to $110         â”‚
â”‚    4. Price drops to $110 â†’ TRIGGER FIRES! Sell executed    â”‚
â”‚                                                              â”‚
â”‚  Key Insight: Trigger only moves UP (for sell), never down. â”‚
â”‚  This "ratchet" effect locks in gains.                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use Cases:**
- Protecting profits while letting winners run
- Trend-following strategies
- Automated position management

---

## Why a Trigger Engine is Required

### The Problem: Stop Orders Cannot Live in the Order Book

The order book is designed for **active orders that can match immediately**:

```
Order Book = Orders that CAN match right now
```

If you put a stop order directly in the order book, it would break:

```
âŒ WRONG APPROACH: Stop Order in Order Book

Scenario: StopLimit Buy
  â€¢ Trigger: $100 (activate when price rises to $100)
  â€¢ Limit: $101 (once active, buy at $101 or less)
  â€¢ Current Market: Best Ask = $99

If placed in book at $101:
  â†’ IMMEDIATELY matches against $99 ask!
  â†’ Trader wanted to buy ONLY IF price RISES to $100 first
  â†’ Complete violation of order intent!
```

### The Solution: Separate Trigger Engine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Two Separate Worlds                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   ORDER BOOK (Active Orders)      TRIGGER ENGINE (Dormant)  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Bids      â”‚ Asks    â”‚         â”‚ Stop Orders         â”‚   â”‚
â”‚   â”‚ $99  100  â”‚ $101 50 â”‚         â”‚ Indexed by trigger  â”‚   â”‚
â”‚   â”‚ $98  200  â”‚ $102 75 â”‚         â”‚ price for fast      â”‚   â”‚
â”‚   â”‚           â”‚         â”‚         â”‚ lookup              â”‚   â”‚
â”‚   â”‚ â†• MATCHING â†•        â”‚         â”‚                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ Waiting... ðŸ’¤       â”‚   â”‚
â”‚            â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚ Trade executes                  â”‚              â”‚
â”‚            â”‚ at $100.50                      â”‚              â”‚
â”‚            â–¼                                 â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ "Hey TriggerEngine, a trade just happened at $100.50"â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ TriggerEngine checks: "Any stops triggered at $100.50?"â”‚ â”‚
â”‚   â”‚ â†’ Found 3 stops! Convert them to real orders         â”‚  â”‚
â”‚   â”‚ â†’ Send those orders to the Order Book for matching   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Trigger Engine Responsibilities

| Responsibility | Purpose |
|---------------|---------|
| **Store dormant stop orders** | Keep them separate from active order book |
| **Index by trigger price** | O(log n) lookup using BTreeMap |
| **Monitor every trade** | Check triggers after each execution |
| **Update trailing stops** | Dynamically adjust trigger prices |
| **Convert to real orders** | Transform triggered stops into Limit/Market |
| **Handle cancellations** | Allow users to cancel pending stops |

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Complete Stop Order Flow                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ User submits â”‚                                                        â”‚
â”‚  â”‚ Stop Order   â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚         â”‚                                                                â”‚
â”‚         â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        API Layer                                  â”‚   â”‚
â”‚  â”‚  Validates: trigger_price, limit_price (if StopLimit), quantity  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                                                â”‚              â”‚
â”‚         â–¼                                                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Regular Order  â”‚                          â”‚    Stop Order       â”‚   â”‚
â”‚  â”‚  (Limit/Market) â”‚                          â”‚ (Stop/StopLimit/    â”‚   â”‚
â”‚  â”‚                 â”‚                          â”‚  TrailingStop)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                              â”‚              â”‚
â”‚           â–¼                                              â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    ORDER BOOK       â”‚                    â”‚    TRIGGER ENGINE      â”‚  â”‚
â”‚  â”‚                     â”‚                    â”‚                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚  buy_stops: BTreeMap   â”‚  â”‚
â”‚  â”‚  â”‚ Bids  â”‚ Asks  â”‚  â”‚                    â”‚  sell_stops: BTreeMap  â”‚  â”‚
â”‚  â”‚  â”‚       â”‚       â”‚  â”‚                    â”‚                        â”‚  â”‚
â”‚  â”‚  â”‚ Price â”‚ Price â”‚  â”‚                    â”‚  Indexed by trigger    â”‚  â”‚
â”‚  â”‚  â”‚ Time  â”‚ Time  â”‚  â”‚                    â”‚  price for O(log n)    â”‚  â”‚
â”‚  â”‚  â”‚Priority Priorityâ”‚ â”‚                    â”‚  range queries         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                                           â”‚               â”‚
â”‚             â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚             â”‚        Triggered orders flow back                         â”‚
â”‚             â”‚        to order book for matching                         â”‚
â”‚             â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      MATCHING ENGINE                             â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚   For each trade executed:                                       â”‚    â”‚
â”‚  â”‚   1. Record trade (price, quantity, parties)                     â”‚    â”‚
â”‚  â”‚   2. Call trigger_engine.on_trade(trade.price)                   â”‚    â”‚
â”‚  â”‚   3. Queue any triggered orders for next matching cycle          â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                 â”‚                                        â”‚
â”‚                                 â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         TRADE OUTPUT                             â”‚    â”‚
â”‚  â”‚   â€¢ WebSocket broadcast                                          â”‚    â”‚
â”‚  â”‚   â€¢ Trade history                                                â”‚    â”‚
â”‚  â”‚   â€¢ User notifications                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Behavior Comparison

### Limit Order vs StopLimit Order

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Limit Order vs StopLimit Order Comparison                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  LIMIT ORDER (Buy at $100)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                          â”‚
â”‚    [Submit Buy Limit @ $100]                                            â”‚
â”‚              â”‚                                                           â”‚
â”‚              â–¼                                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ Immediately enters book â”‚                                          â”‚
â”‚    â”‚ Visible to all traders  â”‚                                          â”‚
â”‚    â”‚ at price level $100     â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                â”‚                                                         â”‚
â”‚                â–¼                                                         â”‚
â”‚    Matches when: Ask price â‰¤ $100                                       â”‚
â”‚    Fills at: $100 or better (lower)                                     â”‚
â”‚                                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  STOPLIMIT ORDER (Trigger: $105, Limit: $106)                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚                                                                          â”‚
â”‚    [Submit StopLimit Buy, Trigger $105, Limit $106]                     â”‚
â”‚              â”‚                                                           â”‚
â”‚              â–¼                                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ Enters TRIGGER ENGINE   â”‚                                          â”‚
â”‚    â”‚ NOT visible in book     â”‚  â† Key difference!                       â”‚
â”‚    â”‚ Waiting for trigger...  â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                â”‚                                                         â”‚
â”‚                â”‚ Market price reaches $105                               â”‚
â”‚                â–¼                                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ TRIGGERED! Converts to  â”‚                                          â”‚
â”‚    â”‚ Limit Buy @ $106        â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                â”‚                                                         â”‚
â”‚                â–¼                                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ NOW enters order book   â”‚                                          â”‚
â”‚    â”‚ at price level $106     â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                          â”‚
â”‚    Matches when: Ask price â‰¤ $106                                       â”‚
â”‚    Fills at: $106 or better (lower)                                     â”‚
â”‚                                                                          â”‚
â”‚  KEY DIFFERENCES:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Aspect                 â”‚ Limit Order     â”‚ StopLimit Order       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Visible in book?       â”‚ Immediately     â”‚ Only after trigger    â”‚   â”‚
â”‚  â”‚ Number of prices       â”‚ 1 (limit)       â”‚ 2 (trigger + limit)   â”‚   â”‚
â”‚  â”‚ Can match immediately? â”‚ Yes             â”‚ No (needs trigger)    â”‚   â”‚
â”‚  â”‚ Information leakage    â”‚ High            â”‚ Low (hidden intent)   â”‚   â”‚
â”‚  â”‚ Use case               â”‚ "Buy at $100"   â”‚ "Buy IF it hits $105" â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Market Order vs StopMarket Order

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Market Order vs StopMarket Order Comparison                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  MARKET ORDER (Sell)                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚                                                                          â”‚
â”‚    [Submit Market Sell]                                                 â”‚
â”‚              â”‚                                                           â”‚
â”‚              â–¼                                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ IMMEDIATELY executes    â”‚                                          â”‚
â”‚    â”‚ against best bid(s)     â”‚                                          â”‚
â”‚    â”‚ No waiting, no resting  â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                â”‚                                                         â”‚
â”‚                â–¼                                                         â”‚
â”‚    Execution: Instant                                                    â”‚
â”‚    Price: Best available (may vary with size)                           â”‚
â”‚                                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  STOPMARKET ORDER (Trigger: $95)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚                                                                          â”‚
â”‚    [Submit StopMarket Sell, Trigger $95]                                â”‚
â”‚              â”‚                                                           â”‚
â”‚              â–¼                                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ Enters TRIGGER ENGINE   â”‚                                          â”‚
â”‚    â”‚ Does NOT execute yet    â”‚  â† Key difference!                       â”‚
â”‚    â”‚ Waiting for price drop  â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                â”‚                                                         â”‚
â”‚                â”‚ Market price reaches $95                                â”‚
â”‚                â–¼                                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ TRIGGERED! Converts to  â”‚                                          â”‚
â”‚    â”‚ Market Sell order       â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                â”‚                                                         â”‚
â”‚                â–¼                                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ NOW executes against    â”‚                                          â”‚
â”‚    â”‚ best available bids     â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                          â”‚
â”‚    Execution: After trigger fires                                        â”‚
â”‚    Price: Best available at trigger time (may slip)                     â”‚
â”‚                                                                          â”‚
â”‚  KEY DIFFERENCES:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Aspect                 â”‚ Market Order    â”‚ StopMarket Order      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ When executes?         â”‚ Immediately     â”‚ When trigger fires    â”‚   â”‚
â”‚  â”‚ Trigger price needed?  â”‚ No              â”‚ Yes                   â”‚   â”‚
â”‚  â”‚ Can rest in book?      â”‚ No              â”‚ No (but waits in TE)  â”‚   â”‚
â”‚  â”‚ Price guarantee?       â”‚ None            â”‚ None                  â”‚   â”‚
â”‚  â”‚ Use case               â”‚ "Sell NOW"      â”‚ "Sell IF price drops" â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  TE = Trigger Engine                                                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Considerations

### Data Structures Required

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Required Data Structures                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1. StopOrderType Enum (new)                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚                                                                          â”‚
â”‚     pub enum StopOrderType {                                            â”‚
â”‚         StopMarket,      // Becomes Market order when triggered         â”‚
â”‚         StopLimit,       // Becomes Limit order when triggered          â”‚
â”‚         TrailingStop,    // Dynamic trigger that follows price          â”‚
â”‚     }                                                                    â”‚
â”‚                                                                          â”‚
â”‚  2. TriggerCondition Enum (new)                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚                                                                          â”‚
â”‚     pub enum TriggerCondition {                                         â”‚
â”‚         AtOrAbove,  // Trigger when price >= trigger_price              â”‚
â”‚         AtOrBelow,  // Trigger when price <= trigger_price              â”‚
â”‚         Above,      // Trigger when price > trigger_price               â”‚
â”‚         Below,      // Trigger when price < trigger_price               â”‚
â”‚     }                                                                    â”‚
â”‚                                                                          â”‚
â”‚  3. StopOrder Struct (new)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                          â”‚
â”‚     pub struct StopOrder {                                              â”‚
â”‚         id: Uuid,                                                       â”‚
â”‚         symbol: String,                                                 â”‚
â”‚         user_id: String,                                                â”‚
â”‚         side: OrderSide,                                                â”‚
â”‚         quantity: Decimal,                                              â”‚
â”‚                                                                          â”‚
â”‚         // Trigger configuration                                        â”‚
â”‚         trigger_price: Decimal,                                         â”‚
â”‚         trigger_condition: TriggerCondition,                            â”‚
â”‚         stop_type: StopOrderType,                                       â”‚
â”‚                                                                          â”‚
â”‚         // For StopLimit orders                                         â”‚
â”‚         limit_price: Option<Decimal>,                                   â”‚
â”‚                                                                          â”‚
â”‚         // For TrailingStop orders                                      â”‚
â”‚         trail_amount: Option<Decimal>,                                  â”‚
â”‚         trail_percent: Option<Decimal>,                                 â”‚
â”‚         highest_price: Option<Decimal>,  // Tracked for sell trailing  â”‚
â”‚         lowest_price: Option<Decimal>,   // Tracked for buy trailing   â”‚
â”‚                                                                          â”‚
â”‚         // Metadata                                                     â”‚
â”‚         status: StopOrderStatus,                                        â”‚
â”‚         created_at: DateTime<Utc>,                                      â”‚
â”‚     }                                                                    â”‚
â”‚                                                                          â”‚
â”‚  4. TriggerEngine Struct (new)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                          â”‚
â”‚     pub struct TriggerEngine {                                          â”‚
â”‚         // Indexed by trigger price for efficient range queries         â”‚
â”‚         buy_stops: BTreeMap<Decimal, Vec<StopOrder>>,                   â”‚
â”‚         sell_stops: BTreeMap<Decimal, Vec<StopOrder>>,                  â”‚
â”‚                                                                          â”‚
â”‚         // O(1) lookup by order ID for cancellations                    â”‚
â”‚         order_index: HashMap<Uuid, Decimal>,                            â”‚
â”‚     }                                                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Matching Engine Integration                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  // After every trade execution, notify the trigger engine:             â”‚
â”‚                                                                          â”‚
â”‚  impl MatchingEngine {                                                  â”‚
â”‚      pub fn execute_order(&mut self, order: Order) -> MatchResult {     â”‚
â”‚          let trades = self.match_order(order);                          â”‚
â”‚                                                                          â”‚
â”‚          // Critical integration point                                  â”‚
â”‚          for trade in &trades {                                         â”‚
â”‚              let triggered = self.trigger_engine.on_trade(trade.price); â”‚
â”‚                                                                          â”‚
â”‚              // Queue triggered orders for next cycle                   â”‚
â”‚              // (avoids recursive matching)                             â”‚
â”‚              for triggered_order in triggered {                         â”‚
â”‚                  self.pending_orders.push(triggered_order);             â”‚
â”‚              }                                                           â”‚
â”‚          }                                                               â”‚
â”‚                                                                          â”‚
â”‚          MatchResult { trades }                                         â”‚
â”‚      }                                                                   â”‚
â”‚  }                                                                       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Performance Considerations

| Operation | Complexity | Notes |
|-----------|------------|-------|
| Add stop order | O(log n) | BTreeMap insertion |
| Cancel stop order | O(log n) | HashMap lookup + BTreeMap removal |
| Check triggers on trade | O(log n + k) | Range query + k triggered orders |
| Update trailing stop | O(1) | Direct update of tracked price |

---

## Summary

| Aspect | Regular Orders | Stop Orders |
|--------|---------------|-------------|
| **Storage** | Order Book | Trigger Engine |
| **Visibility** | Visible to market | Hidden until triggered |
| **Matching** | Immediate | Only after trigger |
| **Price inputs** | 0-1 (market/limit) | 1-2 (trigger + optional limit) |
| **Dynamic pricing** | No | Yes (TrailingStop) |
| **Use case** | "Execute now/at price" | "Execute IF condition met" |

Stop orders are essential for:
- **Risk management**: Automatic loss limiting
- **Breakout strategies**: Enter on momentum
- **Profit protection**: Trail stops to lock gains
- **Reduced information leakage**: Hide trading intent until execution
